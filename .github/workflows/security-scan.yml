name: Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Sundays at midnight
    - cron: '0 0 * * 0'

jobs:
  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for known vulnerabilities in JS libraries
        run: |
          echo "Scanning for known vulnerable JavaScript libraries..."
          # Check for vulnerable libraries (simplified check)
          VULNERABLE_LIBS=(
            "jquery-1."
            "jquery-2."
            "angular-1.0"
            "angular-1.1"
            "angular-1.2"
            "bootstrap-2."
            "lodash-3."
          )
          for lib in "${VULNERABLE_LIBS[@]}"; do
            if grep -r "$lib" --include="*.js" --include="*.html" .; then
              echo "⚠️ Potentially vulnerable library found: $lib"
            fi
          done
          echo "✅ Dependency audit complete"

  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for XSS vulnerabilities
        run: |
          echo "Checking for potential XSS vulnerabilities..."
          # Check for innerHTML without sanitization
          if grep -rn "innerHTML\s*=" --include="*.js" . | grep -v "sanitize\|escape\|encode"; then
            echo "⚠️ Found innerHTML usage - verify sanitization"
          fi
          echo "✅ XSS check complete"
      
      - name: Check for eval usage
        run: |
          echo "Checking for dangerous eval() usage..."
          if grep -rn "eval\s*(" --include="*.js" .; then
            echo "❌ Found eval() usage - security risk!"
            exit 1
          fi
          echo "✅ No eval() usage found"
      
      - name: Check for document.write
        run: |
          echo "Checking for document.write usage..."
          if grep -rn "document\.write" --include="*.js" .; then
            echo "⚠️ Found document.write - consider alternatives"
          fi
          echo "✅ document.write check complete"

  secret-detection:
    name: Secret Detection
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: TruffleHog Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          extra_args: --only-verified
      
      - name: GitLeaks Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  csp-check:
    name: Content Security Policy Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify CSP headers exist
        run: |
          echo "Checking for Content Security Policy..."
          if grep -r "Content-Security-Policy" --include="*.html" .; then
            echo "✅ CSP meta tag found"
          else
            echo "⚠️ No CSP meta tag found in HTML files"
          fi
      
      - name: Check for inline scripts
        run: |
          echo "Checking for inline scripts (CSP violation risk)..."
          # Count inline script tags with content
          INLINE_COUNT=$(grep -c "<script>[^<]" index.html 2>/dev/null || echo "0")
          if [[ "$INLINE_COUNT" -gt "0" ]]; then
            echo "⚠️ Found $INLINE_COUNT inline scripts - may violate strict CSP"
          else
            echo "✅ No problematic inline scripts found"
          fi

  security-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [dependency-audit, static-analysis, secret-detection, csp-check]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Generate security report
        run: |
          echo "# Security Scan Report" > security-report.md
          echo "" >> security-report.md
          echo "**Scan Date:** $(date)" >> security-report.md
          echo "**Commit:** ${{ github.sha }}" >> security-report.md
          echo "" >> security-report.md
          echo "## Summary" >> security-report.md
          echo "- ✅ Dependency audit completed" >> security-report.md
          echo "- ✅ Static analysis completed" >> security-report.md
          echo "- ✅ Secret detection completed" >> security-report.md
          echo "- ✅ CSP check completed" >> security-report.md
          echo "" >> security-report.md
          echo "## Next Steps" >> security-report.md
          echo "Review any warnings in the individual job logs." >> security-report.md
      
      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.md
          retention-days: 90
