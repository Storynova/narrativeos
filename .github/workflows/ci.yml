name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  lint-and-validate:
    name: Lint and Validate
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate HTML
        uses: nicholasadamou/html-validator-action@v1
        with:
          path: '.'
          pattern: '**/*.html'
      
      - name: Lint CSS
        uses: stylelint/stylelint-action@v1
        with:
          args: 'css/**/*.css'
        continue-on-error: true
      
      - name: Lint JavaScript
        uses: reviewdog/action-eslint@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          reporter: github-pr-review
          eslint_flags: 'js/'
        continue-on-error: true

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint-and-validate
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run security scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
      
      - name: Check for hardcoded secrets
        run: |
          echo "Checking for potential secrets..."
          if grep -rE "(api[_-]?key|password|secret|token)\s*[:=]\s*['\"][^'\"]{8,}" --include="*.js" --include="*.html" --include="*.css" .; then
            echo "⚠️ Potential secrets found!"
            exit 1
          fi
          echo "✅ No hardcoded secrets detected"
      
      - name: Check for sensitive files
        run: |
          echo "Checking for sensitive files..."
          SENSITIVE_FILES=(".env" ".env.local" "credentials.json" "secrets.yaml" "*.pem" "*.key")
          for pattern in "${SENSITIVE_FILES[@]}"; do
            if find . -name "$pattern" | grep -q .; then
              echo "⚠️ Sensitive file pattern found: $pattern"
              exit 1
            fi
          done
          echo "✅ No sensitive files detected"

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint-and-validate, security-scan]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate project structure
        run: |
          echo "Validating project structure..."
          required_files=("index.html" "css/styles.css" "js/app.js" "js/security.js" "README.md" "SECURITY.md")
          for file in "${required_files[@]}"; do
            if [[ ! -f "$file" ]]; then
              echo "❌ Missing required file: $file"
              exit 1
            fi
          done
          echo "✅ Project structure validated"
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: narrativeos-build
          path: |
            index.html
            css/
            js/
            prompts/
            docs/
          retention-days: 30

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get version from commit
        id: version
        run: |
          VERSION=$(date +'%Y.%m.%d')-$(echo ${{ github.sha }} | cut -c1-7)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: narrativeos-build
          path: dist/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dist/**
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
